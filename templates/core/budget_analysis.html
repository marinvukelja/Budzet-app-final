{% extends "base.html" %}
{% block content %}
<h2 class="h4 mb-3">Analiza budžeta - {{ current_year }}</h2>

<div class="row g-4 mb-4">
  {% for data in budget_data %}
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="card-title mb-0">{{ data.kategorija_naziv }}</h5>
            <span class="badge 
              {% if data.status == 'over' %}bg-danger
              {% elif data.status == 'warning' %}bg-warning
              {% else %}bg-success{% endif %}">
              {% if data.status == 'over' %}Prekoračen
              {% elif data.status == 'warning' %}Upozorenje
              {% else %}U redu{% endif %}
            </span>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="text-muted">Planirano</small>
              <small class="text-muted">{{ data.total_budget }} €</small>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <small class="text-muted">Potrošeno</small>
              <small class="text-muted">{{ data.actual }} €</small>
            </div>
            <div class="d-flex justify-content-between">
              <small class="text-muted">Preostalo</small>
              <small class="{% if data.remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                {{ data.remaining }} €
              </small>
            </div>
          </div>
          
          <div class="progress mb-3" style="height: 25px;">
            <div class="progress-bar 
              {% if data.percentage > 100 %}bg-danger
              {% elif data.percentage > 80 %}bg-warning
              {% else %}bg-success{% endif %}" 
              role="progressbar" 
              style="width: {{ data.percentage }}%">
              {{ data.percentage|floatformat:1 }}%
            </div>
          </div>
          
          <div class="text-center">
            <small class="text-muted">
              {% if data.remaining < 0 %}
                Prekoračen za {{ data.remaining|floatformat:2|slice:"1:" }} €
              {% elif data.remaining > 0 %}
                Preostalo {{ data.remaining }} €
              {% else %}
                Točno na budžetu
              {% endif %}
            </small>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h5 class="text-muted">Nema budžeta za ovu godinu</h5>
          <p class="text-muted">Dodajte budžete da biste mogli pratiti svoje troškove.</p>
          <a href="{% url 'budzeti' %}" class="btn btn-primary">Dodaj budžet</a>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

{% if budget_data %}
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="h6">Sažetak</h3>
        <canvas id="budgetChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="h6">Statistike</h3>
        <div class="row g-3">
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-primary mb-1">{{ budget_data|length }}</h4>
              <small class="text-muted">Ukupno budžeta</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-success mb-1">
                {% for data in budget_data %}
                  {% if data.status == 'under' %}{{ forloop.counter0|add:1 }}{% endif %}
                {% endfor %}
              </h4>
              <small class="text-muted">U redu</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-warning mb-1">
                {% for data in budget_data %}
                  {% if data.status == 'warning' %}{{ forloop.counter0|add:1 }}{% endif %}
                {% endfor %}
              </h4>
              <small class="text-muted">Upozorenje</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-3 bg-light rounded">
              <h4 class="text-danger mb-1">
                {% for data in budget_data %}
                  {% if data.status == 'over' %}{{ forloop.counter0|add:1 }}{% endif %}
                {% endfor %}
              </h4>
              <small class="text-muted">Prekoračeno</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const ctx = document.getElementById('budgetChart').getContext('2d');
  
  // Definiraj paletu boja za kategorije
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
  ];
  
  // Debug: provjeri ima li podataka
  console.log('Budget data length:', {{ budget_data|length }});
  
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [
        {% for data in budget_data %}'{{ data.kategorija_naziv }}'{% if not forloop.last %},{% endif %}{% endfor %}
      ],
      datasets: [{
        data: [
          {% for data in budget_data %}{{ data.percentage }}{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        backgroundColor: colors.slice(0, {{ budget_data|length }}),
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const labels = [
                {% for data in budget_data %}'{{ data.kategorija_naziv }}'{% if not forloop.last %},{% endif %}{% endfor %}
              ];
              const percentages = [
                {% for data in budget_data %}{{ data.percentage }}{% if not forloop.last %},{% endif %}{% endfor %}
              ];
              const actuals = [
                {% for data in budget_data %}{{ data.actual }}{% if not forloop.last %},{% endif %}{% endfor %}
              ];
              const totals = [
                {% for data in budget_data %}{{ data.total_budget }}{% if not forloop.last %},{% endif %}{% endfor %}
              ];
              
              return labels[context.dataIndex] + ': ' + 
                     percentages[context.dataIndex].toFixed(1) + '% (' + 
                     actuals[context.dataIndex] + '€ / ' + totals[context.dataIndex] + '€)';
            }
          }
        }
      }
    }
  });
</script>
{% endif %}
{% endblock %}
